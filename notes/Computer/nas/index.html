
<!DOCTYPE html>
<html class="borderbox" >
    
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    Nas | DouO's Note</title>
  <meta name="description" content="有時樹會倒下，某片天頃刻明亮
">

  <!-- Favicon -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon" />
  <!-- Windows 8 Tile Icons -->
  <meta name="application-name" content=" Blog">
  <meta name="msapplication-TileColor" content="#5d4d7a">
  <meta name="msapplication-square70x70logo" content="smalltile.png" />
  <meta name="msapplication-square150x150logo" content="mediumtile.png" />
  <meta name="msapplication-wide310x150logo" content="widetile.png" />
  <meta name="msapplication-square310x310logo" content="largetile.png" />
  <!-- Android Lolipop Theme Color -->
  <meta name="theme-color" content="#5d4d7a">
  <script src="/assets/main.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>

    <body>
        <header>
  <nav class="top-nav">
    <div class="container">
      <div class="nav-wrapper">
        <div class="row">
          <div class="col s12 m10 offset-m1">
            <h1 class="header">Nas</h1>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <div class="container"><a href="#" data-target="nav-mobile" class="top-nav sidenav-trigger full hide-on-large-only"><i class="material-icons">menu</i></a></div>
  <ul id="nav-mobile" class="sidenav sidenav-fixed">
    <li>
      <div class="logo">
        <a id="logo-container" href="/notes" class="brand-logo">
          <object id="front-page-logo" type="image/svg+xml">Your browser does not support SVG</object>
        </a>
        <div class="social">
          
          <a href="/rss.xml" title="订阅">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-feed"></use>
            </svg>
          </a>
          
          <a href="https://github.com/douo" title="Github">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-github"></use>
            </svg>
          </a>
          
          <a href="https://stackoverflow.com/users/851344/douo" title="StackOverflow">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-stack-overflow"></use>
            </svg>
          </a>
          
          <a href="https://plus.google.com/102537448648560113422" title="Google Plus">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-google-plus"></use>
            </svg>
          </a>
          
          <a href="https://instagram.com/douo" title="Instagram">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-instagram"></use>
            </svg>
          </a>
          
        </div>
    </li>
    </div>
    <li class="search">
      <div class="search-wrapper">
        <input id="search" placeholder="Search"><i class="material-icons">search</i>
        <div class="search-results"></div>
      </div>
    </li>
    <li class="no-padding">
      <div id="blog-nav">
        <ul>
          
          <li><a href="/">主页</a></li>
          
          <li><a href="/notes">笔记</a></li>
          
          <li><a href="/categories#coder-ref">编码</a></li>
          
          <li><a href="/categories#life-ref">生活</a></li>
          
          <li><a href="/categories#otaku-ref">兴趣</a></li>
          
          <li><a href="/tags">标签</a></li>
          
          <li><a href="/log">日志</a></li>
          
          <li><a href="/help">帮助</a></li>
          
          <li><a href="/about">关于</a></li>
          
        </ul>
      </div>
      <div id="note-nav"></div>
    </li>
  </ul>
  <div id="nav-tab" class="hide-on-med-and-down">
    <div class="row">
      <ul class="tabs">
        <li class="tab col s6"><a href="#blog-nav">博客</a></li>
        <li class="tab col s6"><a href="#note-nav">笔记</a></li>
      </ul>
    </div>
  </div>
</header>
<!-- Page Layout here -->
<main><div class="container">
  <div class="row">

    <div class="content col s12 m8 offset-m1 xl7 offset-xl1"> <div class="post-meta">
<span class="post-date tooltipped" data-tooltip="最后更新 22-01-24">2016-12-08</span>
    
</div>

<article>
    <h1 id="nas">NAS</h1>

<p>Done: Yes
优先级: 4
位置: 其他
标签: 家电
预算: 265</p>

<h1 id="需求">需求</h1>

<ul>
  <li>家庭多媒体中心，需要支持多个设备（TV 手机 PC）</li>
  <li>下载站，迅雷、百度云、BtSync</li>
  <li>照片存储，能挂载成 PC/Mac 磁盘，Lightroom 能直接修改</li>
</ul>

<p>emby + kodi</p>

<p>二手价格</p>

<p>CPU：赛扬 4900 奔腾 G4560 i3  400</p>

<p>主板：H110M  250</p>

<p>固态：M.2 100G 150</p>

<p>内存：4G ddr4  200</p>

<p>电源：250-300w 200</p>

<p>蜗牛星际组 NAS</p>

<p><a href="https://post.smzdm.com/p/a25r4ddq/">蜗牛星际：我集齐了ABCD款，折腾矿渣一个月的全记录！__什么值得买</a></p>

<p><a href="https://blog.ggrarea.cn/archives/29916.html">矿难来袭！速看蜗牛星际矿NAS用料。 - 徐自远的乱七八糟小站</a></p>

<h1 id="功耗">功耗</h1>

<p>639.3 小时，用电量 10.61 kwh。硬盘唤醒功率：24w，硬盘休眠功率 14w。</p>

<h2 id="验证网卡千兆">验证网卡千兆</h2>

<p>iperf 传输速率只有 100mbit</p>

<p>lshw 可查看硬件信息</p>

<p>网卡信息 mii-tool ethtool</p>

<p><a href="https://downloadcenter.intel.com/download/13663/Intel-Network-Adapter-Driver-for-82575-6-82580-I350-and-I210-211-Based-Gigabit-Network-Connections-for-Linux-?product=64404">Download Intel® Network Adapter Driver for 82575/6, 82580, I350, and I210/211-Based Gigabit Network Connections for Linux*</a></p>

<h2 id="archlinux">ArchLinux</h2>

<p>对 Nas 系统了解不多，直观印象就是 Linux 上+ WebUI。我还是喜欢通过 ssh 进行系统管理，所以我选择用 ArchLinux 组建一个 NAS 系统。</p>

<p>配合一台云主机用 Nginx 做反向代理，加上内网穿透技术，相对安全的把服务暴露到互联网。</p>

<h2 id="aurutils">aurutils</h2>

<p>aurutils 的思路是用一个自定义的本地 pacman 源，将 aur 上的包编译后存入本地的源，再通过 pacman -Syu 安装，非常聪明</p>

<p><code>aur sync $package_name</code></p>

<p><code>sudo pacman -Syu $package_name</code></p>

<p>需要建一个本地 pacman 的 repository，详见 <code>man aur</code></p>

<p>aur 被墙可以用清华大学的镜像，比如：</p>

<p><code>env AUR_LOCATION='[https://aur.tuna.tsinghua.edu.cn](https://aur.tuna.tsinghua.edu.cn/)' aur sync -c jellyfin</code></p>

<h2 id="systemd">systemd</h2>

<p><code>alias s='sudo systemctl'</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl set-default multi-user.target
</code></pre></div></div>

<p>固态才16G，日志也不要太大，512足够了</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>journalctl <span class="nt">--vacuum-size</span><span class="o">=</span>512M
</code></pre></div></div>

<p>开机启动的服务：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>● ├─aria2.service
● ├─cps.service
● ├─dnsmasq.service
● ├─frpc.service
● ├─jellyfin.service
● ├─mega.service
● ├─nfs-server.service
● ├─nginx.service
● ├─nmb.service
● ├─privoxy.service
● ├─rslsync.service
● ├─shadowsocks-libev@<span class="k">****</span>.service
● ├─smb.service
● ├─sshd.service
● ├─transmission.service
● ├─<span class="k">****</span>

</code></pre></div></div>

<h2 id="文件共享协议">文件共享协议</h2>

<p>Nas 最重要的功能，就是把存储空间暴露给其他网络上的设备。这方面比较简单，就是 nfs 和 smb。</p>

<h3 id="nfs">NFS</h3>

<p><a href="http://cn.linux.vbird.org/linux_server/0330nfs.php">鸟哥的 Linux 私房菜 – NFS 服务器</a></p>

<p>nfs 的配置起来比较简单，不幸权限管理要细化起来还是比较麻烦的。</p>

<p>把目录开放给主机，实际主机上的应用程序都有了读取 nfs 目录的能力。</p>

<p>相对安全要求不高的情景，我还是直接用 all_squash root_squash，然后再用 anonuid anongid 设置特定的用户。</p>

<p>安全性需要搭配 Kerberos 使用，太繁琐。</p>

<p>Mac 经常会断掉</p>

<p><a href="https://www.cyberciti.biz/faq/apple-mac-osx-nfs-mount-command-tutorial/">macOS X Mount NFS Share / Set an NFS Client - nixCraft</a></p>

<p>使用 nfs.map :</p>

<p><a href="https://www.kernelcrash.com/blog/nfs-uidgid-mapping/2007/09/10/">NFS uid/gid mapping</a></p>

<h4 id="kodi">Kodi</h4>

<p>kodi 需要 insecure，见 <a href="https://kodi.wiki/view/NFS#NFS_sharing_from_Linux">3 NFS sharing from Linux</a></p>

<h3 id="samba">Samba</h3>

<p>启用  <code>smb</code> 和 <code>nmb</code>，不要去启用 <code>samba</code></p>

<h2 id="权限">权限</h2>

<p>各类下载软件的默认都用各种的用户和组，修改各种 systemd 脚本不好维护。</p>

<ol>
  <li>用 <code>setfacl</code> 精细化控制各个目录各个用户的权限，ex：<code>setfacl -d -m u:user:rwx target</code></li>
  <li>用组管理，比如 download media 作为各个目录的组权限，再把需要的用户加入组中。</li>
</ol>

<p>方案 2 足够简单且基本覆盖当前需求</p>

<h2 id="媒体服务器">媒体服务器</h2>

<p>只做文件共享的 NAS 和 SAN 又有什么区别呢😁？</p>

<h2 id="jellyfin">jellyfin</h2>

<p>Kodi 更像一个带资源管理器的播放器，不能脱离GUI，没有一般意义的 server 版本。</p>

<p><a href="https://github.com/linuxserver/docker-kodi-headless">linuxserver/docker-kodi-headless</a></p>

<p>Emby 3.6 之后也不开源了，代替品</p>

<p><a href="https://github.com/jellyfin/jellyfin">jellyfin/jellyfin</a></p>

<p>安装了 jellyfin 后还安装了 FFmpeg</p>

<p><a href="http://192.168.1.6:8888/gui/">http://192.168.1.6:8</a>096</p>

<p>将用户加入组 jellyfin 方便修改 jellfin 生成的文件</p>

<p>rslsync 和 jellyfin  在 1900 端口有冲突</p>

<h2 id="openmediavault">OpenMediaVault</h2>

<p><a href="https://www.openmediavault.org/download.html">Download | openmediavault</a></p>

<h2 id="aria2">aria2</h2>

<pre><code>sudo pacman -Syu aria2
</code></pre>

<p>配置文件 <code>/etc/conf.d/aria2c.conf</code> ，修改下载目录和启用 rpc。见 <a href="https://github.com/douo/sensitive/blob/master/nas/aria2c.conf">aria2c.conf</a></p>

<p><code>systemctl start aria2cd.service</code></p>

<h2 id="btsync">btsync</h2>

<p><a href="http://192.168.1.6:8888/gui/">http://192.168.1.6:8888/gui/</a></p>

<p>需要搭配 ss 使用，手动建需要fq的地址加入 privoxy 的gfwlist 配置里面，在 app 设置代理为 privoxy</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config.getsync.com
config.resilio.com
173.244.217.42
209.95.56.60
107.182.230.198
173.244.209.150
54.235.182.157
</code></pre></div></div>

<h2 id="transmission">Transmission</h2>

<p>鉴于 bt 下载都是通过预分配空间再来写入数据来减少碎片，直接在存放媒体的 8t 叠瓦盘上下载就不太合适了，所以我用闲置的 ssd 来做下载盘，下载完成后再移入目标磁盘。通过开启 incomplete_dir 来实现这个功能。这个功能需要修改 <code>/var/lib/transmission/.config/transmission-daemon/settings.json</code> 。其实用了 ssd 预分配也可以关掉，毕竟 ssd 可以不管文件碎片化了，预分配浪费一次写入也对寿命无益，不过，0占位的文件可能已经被文件系统优化了，所以未经验证的认为影响应该不大。不过我还是关掉了。</p>

<p>需要注意， 停止服务后，才能修改 settings.json 。不然 stop 的时候会重置 settings.json</p>

<p>另外还要注意权限问题，transmission 是以 transmission:transmission 这个用户来操作的。</p>

<h3 id="incomplete-dir">Incomplete-dir</h3>

<p>设置下载中的目录到 ssd，避免折腾坏叠瓦盘。</p>

<p>transmission 可以通过设置 incomplete-dir 来实现，<code>/etc/transmission-daemon/settings.json</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"incomplete-dir"</span>: <span class="s2">"/mnt/ssd/srv/bt"</span>,
<span class="s2">"incomplete-dir-enabled"</span>: <span class="nb">true</span>,
</code></pre></div></div>

<blockquote>
  <p>The incomplete-dir appears to be used only when the download-dir matches the entered folder when adding the torrent. You could argue that the free selection of download folder (which could be on another filesystem entirely) conflicts with using a single incomplete-dir. So I would suggest explicitly not using the incomplete-dir setting at all as it is not used when selecting a download folder that differs from download-dir anyway.</p>
</blockquote>

<h3 id="transmission-daemon-udp-failed-to-set-receive--send-buffer">transmission-daemon: UDP Failed to set receive / send buffer</h3>

<p><a href="https://unix.stackexchange.com/questions/520625/transmission-daemon-udp-failed-to-set-receive-send-buffer">debian - transmission-daemon: UDP Failed to set receive / send buffer - Unix &amp; Linux Stack Exchange</a></p>

<h3 id="transmission-tracker-add">transmission-tracker-add</h3>

<p><a href="https://github.com/AndrewMarchukov/tracker-add">AndrewMarchukov/tracker-add: Fully automated script for adding more trackers to Transmission.</a></p>

<h2 id="book">Book</h2>

<ul>
  <li>calibre 创建维护书库</li>
  <li>calibre-web，作为 书库（calibredb） 的前端，calibre 提供的web端太简略</li>
  <li>calibre-helper，监控特定目录下的文件变更，自动添加进书库</li>
</ul>

<p>这些命令都需要编辑同一个目录，需要统一权限</p>

<h3 id="calibre">calibre</h3>

<p>书用 calibre 来管理，calibre 会将书复制到 CALIBRE_LIBRARY_PATH，一本书在 nas 起码上存在两份。</p>

<ul>
  <li>安装 calibre 主要是用它的命令行工具，来管理 CALIBRE_LIBRARY_PATH。</li>
  <li>找不到 headless 的版本，安装 calibre 引入一堆用不上的 qt 依赖，有点难受。</li>
  <li>还有很强大的阅读功能也用不上。</li>
  <li>在 mac/pc 上也可以通过 nfs 挂载这个目录，直接用本地的 calibre ui 来管理和阅读。</li>
  <li>没有译者字段，应该可以自定义metadata</li>
  <li>另外解析 pdf 元数据的时候有个小 bug，还给提了 <a href="https://github.com/kovidgoyal/calibre/pull/1473">PR</a></li>
</ul>

<h3 id="calibre-web">calibre-web</h3>

<p>建议用 <code>aurutils</code> 安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aur <span class="nb">sync </span>calibre-web
</code></pre></div></div>

<ul>
  <li>权限 calibre-web:calibre-web</li>
  <li>默认端口 8083</li>
  <li>可能需要一个空 metadata.db 支持 <a href="https://github.com/kovidgoyal/calibre/blob/master/src/calibre/db/tests/metadata.db">https://github.com/kovidgoyal/calibre/blob/master/src/calibre/db/tests/metadata.db</a></li>
  <li>支持编辑 metadata，需要对 CALIBRE_LIBRARY_PATH 有写权限</li>
</ul>

<h3 id="calibre-helper">calibre-helper</h3>

<p>脚本见 <a href="https://gist.github.com/douo/204923325f5f7526176108a39f038034">calibrew_helper</a>，监听目录变化并自动导入 calibre.</p>

<pre><code>sudo pacman -Syu inotify-tools poppler
</code></pre>

<ul>
  <li><code>inotify-tools</code> 用于实现监听目录</li>
  <li><code>poppler</code> calibre 需要依赖 <code>pdfinfo</code></li>
</ul>

<p>目前只实现对于新增/修改文件的添加，删除会被忽略。主要是用于监听 rslsync 的目录。</p>

<p>TODO</p>

<ul>
  <li>频繁变更是否需要一个队列来避免通知丢失</li>
  <li>出现重复如何处理，calibre 通过 title 和 authors 判断是否重复。有些书的标题都是 untitled 或者是其他一致的无意义字符，直接覆盖也是不合理的</li>
  <li><code>calibredb add ...  -e override</code> 可实现自动覆盖</li>
  <li>权限与 calibre-web 一致，写入的文件，calibre-web 才能更改</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/systemd/system/calibre-helper.service</span>
<span class="o">[</span>Unit]
<span class="nv">After</span><span class="o">=</span>rslsync.service
<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>calibre-web
<span class="nv">Group</span><span class="o">=</span>calibre-web
<span class="nv">ExecStart</span><span class="o">=</span>/opt/bin/calibre_helper.sh
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>default.target
</code></pre></div></div>

<h2 id="内网穿透">内网穿透</h2>

<p>选用 <code>frp</code>，配置见</p>

<ul>
  <li><a href="https://github.com/douo/sensitive/blob/master/nas/frpc.ini">frpc.ini</a></li>
  <li><a href="https://github.com/douo/sensitive/blob/master/nas/frpc_tencent.ini">frpc_tencent.ini</a></li>
  <li><a href="https://github.com/douo/sensitive/blob/master/nas/nginx.conf">nginx.conf</a></li>
</ul>

<p>端口：</p>

<ul>
  <li>Nas webUI 80/443</li>
  <li>rslsync webui 8888</li>
  <li>transmission 9091</li>
  <li>calibre-web 8083</li>
  <li>jellyfin 8096</li>
</ul>

<p>Requirement</p>

<ul>
  <li>云主机（必须）</li>
  <li>域名（可选）</li>
</ul>

<p>frp 做穿透</p>

<p>nginx 做反向代理，可以实现全部走80端口，根据不同子域名派发到各种的服务</p>

<p>为了实现相同的域名可以在外网和内网同时访问到服务，有两个方案：</p>

<h3 id="方案1">方案1</h3>

<ul>
  <li>外网：云主机(nginx → frps) → 内网主机（frpc →具体服务）</li>
  <li>内网：内网主机（nginx → 具体服务）</li>
</ul>

<p>外网访问由frp来做反向代理，而内网又需要 nginx 来做反向服务，需要部署两套规则。</p>

<p><img src="Untitled%201.png" alt="NAS%20306933e74a424c04892d6b5ddc49eabe/Untitled%201.png" /></p>

<h3 id="方案2">方案2</h3>

<p>外网：云主机（nginx → frps）→内网主机（frpc → nginx → 具体服务）</p>

<p>内网：内网主机（nginx → 具体服务）</p>

<p>看起来多了一层，但反向代理的职责主要都交给了 nginx，而 frp 只需要代理一个 tcp 端口而已。规则简单了许多。</p>

<p>ssl 一定要在末端启用。</p>

<h3 id="xray-xlts">xray xlts</h3>

<p>对于方案二来说，xray 或torjan 的回落也是可以起到简单转发的作用，nginx 这里是可以不用的。不过 nginx 还是值得的，比较多了一些控制和灵活性。</p>

<p>回落到 nginx 只能回来到 80 端口，因为流量已经被解密了。所以需要注意让外部 ip 访问 80 端口转发到 https：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
       <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
       <span class="kn">server_name</span> <span class="s">....</span>
       <span class="c1"># 阻止外部ip直接走 http</span>
       <span class="s">if</span> <span class="s">(</span> <span class="nv">$remote_addr</span> <span class="s">!=</span> <span class="mi">127</span><span class="s">.0.0.1</span> <span class="s">)</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">^</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="s">?</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
       <span class="kn">...</span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h3 id="安全">安全</h3>

<p>暴露到公网，最基本的安全还是要的：</p>

<p>启用 http basic auth</p>

<ol>
  <li><code>sudo htpasswd -c /etc/nginx/.htpasswd user pass</code></li>
  <li>找个[在线服务][https://www.web2generators.com/apache-tools/htpasswd-generator]直接生成</li>
</ol>

<h3 id="证书">证书</h3>

<p>使用通配符证书还是最方便的</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>certbot certonly <span class="nt">--manual</span> <span class="se">\</span>
<span class="nt">--preferred-challenges</span><span class="o">=</span>dns <span class="se">\</span>
<span class="nt">--email</span> dourokinga@gmail.com <span class="se">\</span>
<span class="nt">--server</span> <span class="o">[</span>https://acme-v02.api.letsencrypt.org/directory]<span class="o">(</span>https://acme-v02.api.letsencrypt.org/directory<span class="o">)</span> <span class="se">\</span>
<span class="nt">--agree-tos</span> <span class="se">\</span>
<span class="nt">-d</span> <span class="s2">"*.dourok.info"</span>
</code></pre></div></div>

<p>检查 dns txt 记录生效：</p>

<pre><code>nslookup -type=txt
</code></pre>

<h2 id="硬盘管理">硬盘管理</h2>

<p>更新：内置 16G 固态已经损害。用 256 的 SSD 安装系统。再把 /var 独立分区，幸好还有一个 sata 接口可以作为启动盘。</p>

<p>见 :<a href="https://github.com/douo/sensitive/blob/master/nas/fstab">fstab</a></p>

<p>机械硬盘设置 30 分钟定时休眠：</p>

<pre><code>sudo hdparm -S 241 /dev/sdx
</code></pre>

<h3 id="ssd-250g">SSD 250G</h3>

<p>用 <code>btrfs</code>，两个主要作用</p>

<ul>
  <li>挂载 /var 目录</li>
  <li>临时下载目录</li>
</ul>

<p>主要分为两个 <code>subvolume</code></p>

<ul>
  <li>var 挂载 /var ： <code>mount -t btrfs -o subvol=val,defaults /dev/sdc1 /var</code></li>
  <li>srv 临时下载目录，需要设置 quota，不要让这这个目录把硬盘写满</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>btrfs qgroup limit <span class="s1">'200g'</span> srv

<span class="nb">sudo </span>btrfs qgroup show <span class="nt">-pcre</span> /mnt/ssd
</code></pre></div></div>

<h3 id="2t">2T</h3>

<p>现状：</p>

<p>49G	./temp
737G	./.18p
1.6G	./aria2
16K	./lost+found
11M	./rslsync
<em>20G	./works</em>
453G	./.transmission
226G	./archives
66G	./games
1.6T	.</p>

<p>长期用途下载盘+缓存：</p>

<ul>
  <li>transmission</li>
  <li>rslsync</li>
  <li>aria2</li>
  <li>webDav*</li>
  <li>jellfin 缓存（/mnt/seagate_3t/jellyfin）</li>
  <li>pacman 缓存</li>
  <li>18p 资源（）</li>
</ul>

<p>下载资源，完成后复制到8T归档，2T 磁盘需要定期清理。</p>

<h3 id="3t">3T</h3>

<p>现状：</p>

<p>40G	./download
741G	./pictures
16K	./lost+found
30G	./resources
36G	./电子书资源共享（中文）
9.5G	./jellyfin
1.7T	./media
61G	./MainCalibre
12K	./.Trashes
30G	./Games
2.6T	.</p>

<p>长期用途：备份盘+低强度工作</p>

<ul>
  <li>Lightroom 图片库（是否支持 nfs）</li>
  <li>图书</li>
  <li>游戏</li>
  <li>音乐归档</li>
  <li>代码备份(rsync 定期备份 或 rslsync )</li>
  <li>历史工作目录备份</li>
  <li>个人资料（+ google drive）</li>
</ul>

<h3 id="8t">8T</h3>

<p>希捷 SMR 磁盘。主要存放影视资源供本地播放器（Jellfin）使用</p>

<p>33G	./music
420M	./comic
1.2G	./game
812G	./staging
22G	./documentary
247G	./movies
546G	./episodes</p>

<h2 id="权限-1">权限</h2>

<p>主用户属于 users(985)</p>

<p>transmission 有自己的用户和组</p>

<p>jellyfin 有自己的用户和组</p>

<h1 id="弃用">弃用</h1>

<p><a href="https://www.notion.so/b57390ab888445e3a97329fe437848df">布线</a></p>

<h2 id="mega">mega</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Description</span><span class="o">=</span>Mega Cmd Service
<span class="nv">After</span><span class="o">=</span>local-fs.target network.target
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/mega-cmd-server
<span class="nv">WorkingDirectory</span><span class="o">=</span>/mnt/seagate_2t/
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h2 id="ss">ss</h2>

<p>与wiki不一致，见 <a href="https://github.com/shadowsocks/shadowsocks-libev/issues/1949#issuecomment-369467859">https://github.com/shadowsocks/shadowsocks-libev/issues/1949#issuecomment-369467859</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>shadowsocks-libev@us8.service
</code></pre></div></div>

<p>proxychain-ng  可实现对当个进程的代理</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>pacman <span class="nt">-Syu</span> privoxy proxychains-ng
</code></pre></div></div>

<p>最终方案 prixovy 将 sock5 代理转换为 http 代理。可通过配置实现 gfwlist <a href="https://www.zfl9.com/ss-local.html#gfwlist">https://www.zfl9.com/ss-local.html#gfwlist</a> 。再通过 proxychain-ng 全局走 prixovy 代理</p>

<p>检验一下是否有走 ss</p>

<p><code>proxychains curl [https://api.ipify.org](https://api.ipify.org/)\?format\=json</code></p>

<h2 id="tc-play">tc-play</h2>

<p><a href="https://github.com/veracrypt/tc-play">veracrypt/tc-play</a></p>

<p>这个版本已经编译不过了，用我 fork 的版本</p>

<p><a href="https://github.com/douo/tc-play/commit/ac63ea0e426ac31ba17202b1f97fcf34df6747c4">Update tcplay.c · douo/tc-play@ac63ea0</a></p>

<p>写入速度还是可以的</p>

<p><img src="Untitled.png" alt="Untitled.png" />b</p>

</article>
<div class="tag-container" >
    
</div>


<div id="disqus_thread"></div>
<script>

 /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
 var jekyll_id = "/notes/Computer/nas"
 var disqus_config = function () {
     this.page.title = "Nas"
     this.page.identifier = "posts"+jekyll_id.substring(jekyll_id.lastIndexOf('/'))+".md"; // required: replace example with your forum shortname
     console.log(this.page.identifier);
     this.page.url = "http://dourok.info/notes/Computer/nas/";
    };

 (function() { // DON'T EDIT BELOW THIS LINE
     var d = document, s = d.createElement('script');
     s.src = '//doousblog.disqus.com/embed.js';
     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




<a class="btn-floating btn-large waves-effect waves-light scale-transition fab" id="fab"><i class="material-icons">keyboard_arrow_up</i></a>
</div>
    <div class="col hide-on-small-only m1 xl1 ">
        <a class="btn-floating teal" id='toc-toggle'><i id='toc-toogle-icon' class="material-icons">compare_arrows</i></a>
      </div>
    <div class="col hide-on-small-only m3 xl3 offset-xl1 toc-wrapper">
      <ul class="section table-of-contents">
      </ul>
    </div>
  </button>
</div>
</main>

<footer>
    <div class="container">
        <div class="row">
            <div class="col s12 m5 offset-m1">
                <h5>友情链接</h5>
                <ul class="mdl-mega-footer__link-list">
                    
                    <li><a href="https://magicalboy.com/">MAGICALBOY</a></li>
                    
                    <li><a href="http://www.cnlvzi.com/">驴子博客</a></li>
                    
                </ul>
            </div>
            <div class="col s12 m5">
                <div class="footer-nav">
                    
                    <a href="/">主页</a>
                    
                    <a href="/notes">笔记</a>
                    
                    <a href="/categories#coder-ref">编码</a>
                    
                    <a href="/categories#life-ref">生活</a>
                    
                    <a href="/categories#otaku-ref">兴趣</a>
                    
                    <a href="/tags">标签</a>
                    
                    <a href="/log">日志</a>
                    
                    <a href="/help">帮助</a>
                    
                    <a href="/about">关于</a>
                    
                </div>
        </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            <div class="row">
                <div class="col offset-m1">
                    ©2009-世界末日 | 基於 <a href="https://jekyllrb.com">Jekyll</a> | 主题 <a href="#">Moon</a> | <small class="license">
	                  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="https://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" original="https://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png"></a>
	                  </small>
                </div>
            </div>
        </div>
    </div>
</footer>



        

        

        
    </body>

</html>
