
<!DOCTYPE html>
<html class="borderbox" >
    
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    2020年10月07日杂记 | DouO's Note</title>
  <meta name="description" content="有時樹會倒下，某片天頃刻明亮
">

  <!-- Favicon -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon" />
  <!-- Windows 8 Tile Icons -->
  <meta name="application-name" content=" Blog">
  <meta name="msapplication-TileColor" content="#5d4d7a">
  <meta name="msapplication-square70x70logo" content="smalltile.png" />
  <meta name="msapplication-square150x150logo" content="mediumtile.png" />
  <meta name="msapplication-wide310x150logo" content="widetile.png" />
  <meta name="msapplication-square310x310logo" content="largetile.png" />
  <!-- Android Lolipop Theme Color -->
  <meta name="theme-color" content="#5d4d7a">
  <link rel="stylesheet" href="/assets/main.css">
  <script src="/assets/main.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>

    <body>
        <header>
  <nav class="top-nav">
    <div class="container">
      <div class="nav-wrapper">
        <div class="row">
          <div class="col s12 m10 offset-m1">
            <h1 class="header">2020年10月07日杂记</h1>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <div class="container"><a href="#" data-target="nav-mobile" class="top-nav sidenav-trigger full hide-on-large-only"><i class="material-icons">menu</i></a></div>
  <ul id="nav-mobile" class="sidenav sidenav-fixed">
    <li>
      <div class="logo">
        <a id="logo-container" href="/notes" class="brand-logo">
          <object id="front-page-logo" type="image/svg+xml">Your browser does not support SVG</object>
        </a>
        <div class="social">
          
          <a href="/rss.xml" title="订阅">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-feed"></use>
            </svg>
          </a>
          
          <a href="https://github.com/douo" title="Github">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-github"></use>
            </svg>
          </a>
          
          <a href="https://stackoverflow.com/users/851344/douo" title="StackOverflow">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-stack-overflow"></use>
            </svg>
          </a>
          
          <a href="https://plus.google.com/102537448648560113422" title="Google Plus">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-google-plus"></use>
            </svg>
          </a>
          
          <a href="https://instagram.com/douo" title="Instagram">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-instagram"></use>
            </svg>
          </a>
          
        </div>
    </li>
    </div>
    <li class="search">
      <div class="search-wrapper">
        <input id="search" placeholder="Search"><i class="material-icons">search</i>
        <div class="search-results"></div>
      </div>
    </li>
    <li class="no-padding">
      <div id="blog-nav">
        <ul>
          
          <li><a href="/">主页</a></li>
          
          <li><a href="/notes">笔记</a></li>
          
          <li><a href="/categories#coder-ref">编码</a></li>
          
          <li><a href="/categories#life-ref">生活</a></li>
          
          <li><a href="/categories#otaku-ref">兴趣</a></li>
          
          <li><a href="/tags">标签</a></li>
          
          <li><a href="/log">日志</a></li>
          
          <li><a href="/help">帮助</a></li>
          
          <li><a href="/about">关于</a></li>
          
        </ul>
      </div>
      <div id="note-nav"></div>
    </li>
  </ul>
  <div id="nav-tab" class="hide-on-med-and-down">
    <div class="row">
      <ul class="tabs">
        <li class="tab col s6"><a href="#blog-nav">博客</a></li>
        <li class="tab col s6"><a href="#note-nav">笔记</a></li>
      </ul>
    </div>
  </div>
</header>
<!-- Page Layout here -->
<main><div class="container">
  <div class="row">

    <div class="content col s12 m8 offset-m1 xl7 offset-xl1"> <div class="post-meta">
<span class="post-date tooltipped" data-tooltip="最后更新 20-11-16">2020-10-07</span>
    
</div>

<article>
    <h2 id="go">go</h2>

<p>golang 最反直觉的就是 GOPATH http://c.biancheng.net/view/4773.html</p>

<p>幸好有了 go mod</p>

<h3 id="项目结构">项目结构</h3>

<p>repository -&gt; module  -&gt; packages(a collection of source files in the same directory that are compiled together)</p>

<p>go 不支持范型</p>

<p>在 Go 中，如果一个名字以大写字母开头，那么它就是已导出的。任何“未导出”的名字在该包外均无法访问。</p>

<p>变量需要声明可用 <code>var</code>，也可以用短变量声明 <code>:=</code>（类型推导） 但不能在函数体外使用，也有常量关键字 const</p>

<p>多返回值：函数可以返回多个不同类型的结果。</p>

<p>Go 在不同类型的项之间赋值时需要显式转换。</p>

<p>循环结构：Go 只有一种循环结构：for 循环，类 c 的语法，只不过更灵活 支持  <code>for sum &lt; 1 {}</code>、<code>for {}</code></p>

<p>条件语句：</p>

<ul>
  <li>if 无需小括号</li>
  <li>switch case，只运行一个 case，支持无条件 switch（等同 if-else）</li>
</ul>

<p><code>defer</code> 语句会将函数推迟到外层函数返回之后执行。defer 是一个栈</p>

<h3 id="指针">指针</h3>

<ul>
  <li>值类型 <code>Type</code>，对应指针类型 <code>*Type</code></li>
  <li>取指 <code>ptr = &amp;value</code></li>
  <li>取值 <code>value = *ptr</code></li>
</ul>

<h3 id="数组">数组</h3>

<ul>
  <li>数组在初始化之后大小就无法改变</li>
  <li>
    <p>存储元素类型相同、但是大小不同的数组类型在 Go 语言看来也是完全不同的，只有两个条件都相同才是同一个类型。</p>

    <pre><code>  var a [10]int // 默认取零值
  primes := [6]int{2, 3, 5, 7, 11, 13}
  primes := [...]int{2, 3, 5, 7, 11, 13} // [...]T 声明数组，语法糖。Go 语言会在编译期间通过源代码对数组的大小进行推断
</code></pre>
  </li>
</ul>

<h3 id="切片">切片</h3>

<p>运行时切片由如下的 SliceHeader 结构体表示，其中 Data 字段是指向数组的指针，Len 表示当前切片的长度，而 Cap 表示当前切片的容量，也就是 Data 数组的大小</p>

<pre><code>type SliceHeader struct {
	Data uintptr
	Len  int
	Cap  int
}
</code></pre>

<p>切片运算</p>

<pre><code>a[low : high]  //[low,high)
</code></pre>

<p>切片文法，切片文法类似于没有长度的数组文法</p>

<pre><code>[]bool{true, true, false}
slice := make([]int, 10)
</code></pre>

<p>在进行切片时，你可以利用它的默认行为来忽略上下界。切片下界的默认值为 0，上界则是该切片的长度。
切片的零值是 nil。</p>

<p>可通过 append 函数扩展cap。类似其他语言的 list</p>

<pre><code>for i, v := range pow {
	fmt.Printf("2**%d = %d\n", i, v)
}
</code></pre>

<h3 id="make--new">make &amp; new</h3>

<ul>
  <li>make 的作用是初始化内置的数据结构，也就是我们在前面提到的切片、哈希表和 Channel2；</li>
  <li>new 的作用是根据传入的类型分配一片内存空间并返回指向这片内存空间的指针3；</li>
</ul>

<h3 id="hashmap">hashmap</h3>

<p><code>map</code></p>

<pre><code>m = make(map[string]Vertex)

var m = map[string]Vertex{
"Bell Labs": Vertex{
	40.68433, -74.39967,
},
"Google": {  //Vertex 可省略
	37.42202, -122.08408,
}, }
</code></pre>

<h3 id="function">function</h3>

<p>go 函数的最大特点就是可以返回多个值，go 使用栈传递参数和接收返回值，所以它只需要在栈上多分配一些内存就可以返回多个值。</p>

<p>参数传值而不是传引用。传递结构体时：会对结构体中的全部内容进行拷贝；传递结构体指针时：会对结构体指针进行拷贝；</p>

<p>go 的函数就是一个闭包</p>

<h3 id="面向对象">面向对象</h3>

<p>go 没有类关键字。</p>

<p>用 struct 作为 data class</p>

<pre><code>type Student struct {
    Name string
    Age  int
}
</code></pre>

<p>创建对象：</p>

<pre><code>var a Student    // a == Student{"", 0}  直接创建一个零值对象，返回的是值引用
a.Name = "Alice" // a == Student{"Alice", 0}

var pa *Student   // pa == nil
pa = new(Student) // pa == &amp;Student{"", 0} 返回的是指针
pa.Name = "Alice" // pa == &amp;Student{"Alice", 0}
</code></pre>

<p>另一个例子：</p>

<pre><code>type Vertex struct {
    X int
    Y int
}
</code></pre>

<p>构造</p>

<pre><code>var (
	v1 = Vertex{1, 2}  // 创建一个 Vertex 类型的结构体
	v2 = Vertex{X: 1}  // Y:0 被隐式地赋予
	v3 = Vertex{}      // X:0 Y:0
	p  = &amp;Vertex{1, 2} // 创建一个 *Vertex 类型的结构体（指针）
)
</code></pre>

<p>无论是值还是指针引用，都是用同样的语法访问属性，这是个<strong>语法糖</strong>不注意的话很容易迷惑。</p>

<p>还可以通过 struct 字面量创建对象：</p>

<pre><code>b := Student{ // b == Student{"Bob", 0}
    Name: "Bob",
}

pb := &amp;Student{ // pb == &amp;Student{"Bob", 8}
    Name: "Bob",
    Age:  8,
}
</code></pre>

<p>通过对函数添加接收者，让其变为接收者的方法。</p>

<pre><code>func (v Vertex) Abs() float64 {
	return math.Sqrt(v.X*v.X + v.Y*v.Y)
}
</code></pre>

<p>方法只是个带接收者参数的函数。看似很讨巧（避免 NPE），不过貌似实例方法多起来，还是很繁琐的。</p>

<p>看起来类似 kotlin 的 extension， ruby 的  open class 。但实际上** func 与接收者必须在同一个包下**，这也就断了实现 kotlin extension method 的路。</p>

<p>mutable 方法，需要用到指针接收者</p>

<pre><code>func (v *Vertex) Scale(f float64) {
	v.X = v.X * f
	v.Y = v.Y * f
}
</code></pre>

<p>接口类型 是由一组方法签名定义的集合。</p>

<p>type Abser interface {
	Abs() float64
}</p>

<p>go 的接口实现是隐式的，其实也是方法指定接收者这种设计决定。好像叫做鸭子类型</p>

<h4 id="类型断言">类型断言</h4>

<pre><code>t, ok := i.(T)
</code></pre>

<p>类似强制类型转换，若 i 保存了一个 T，那么 t 将会是其底层值，而 ok 为 true。否则，ok 将为 false 而 t 将为 T 类型的零值，程序并<strong>不会产生恐慌</strong>。</p>

<h4 id="类型选择">类型选择</h4>

<pre><code>switch v := i.(type) {
case T:
    // v 的类型为 T
case S:
    // v 的类型为 S
default:
    // 没有匹配，v 与 i 的类型相同
}
</code></pre>

<h3 id="异常机制">异常机制</h3>

<h4 id="check-exception">Check Exception</h4>

<p>没有 try-catch 机制，没有类 throw 的机制，错误通过函数的多返回值实现 Either，出错时提前返回退出函数。</p>

<p>声明一个函数会返回错误：</p>

<pre><code>func Open(name string) (file *File, err error)
</code></pre>

<p>错误处理：</p>

<pre><code>f, err := os.Open("filename.ext")
if err != nil {
    log.Fatal(err)
}
// do something with the open *File f
</code></pre>

<p>感觉和 java 的 check exception 有点殊途同归的意思，不过用起来也是同样繁琐。</p>

<p>创建 error 的两种方法： <code>fmt.Errorf</code>、<code>errors.New</code>。<code>error</code> 就是一个实现如下接口的类：</p>

<pre><code>type Error interface{
    func Error() string
}
</code></pre>

<p>问题，</p>
<ol>
  <li>一个操作多个调用都可能抛出 err，如何优雅 D 处理</li>
  <li>返回的 err 丧失调用栈的信息，多层返回后不知道哪个函数或哪行代码抛出。</li>
</ol>

<h4 id="wrap-error">Wrap Error</h4>

<p>可见 go 一开始的错误机制设计还是有一些问题了，go 1.13 后，做了更新：</p>

<p><a href="https://blog.golang.org/go1.13-errors">Working with Errors in Go 1.13 - The Go Blog</a></p>

<ul>
  <li>使用 wrap error 的目的，为了传递更多的出错信息或上下文</li>
  <li>wrap error 注意避免暴露实现细节，特别是不要徒增依赖</li>
</ul>

<h4 id="runtime-exception">Runtime Exception</h4>

<p>对于数组越界，空指针之类的 runtime 异常，简单的说会抛出（调用）一个 <code>panic</code>， <code>panic</code> 是一个内建函数，调用它会停止当前函数的执行（之前声明的 defer 会继续执行），并沿调用栈一层层抛出，直到遇到 <code>recover</code>。 <code>recover</code> 也是内建函数，返回 panic 携带的消息（string），同时会让 <code>goroutine</code> 回到正常的控制流，也就是阻止了 <code>panic</code> 的继续向上传播。<code>recover</code> 只能在 <code>defer</code> 内执行</p>

<pre><code>func main() {
	g()
	println("after g")
}

func g() {
	defer func() {
		println("defer")
		if r := recover(); r != nil {
			fmt.Printf("Recovered in g:%T %v \n", r, r)
		}
	}()
	panic("wtf")
}
</code></pre>

<p>输出：</p>

<pre><code>defer
Recovered in g:string wtf
after g
</code></pre>

<p><a href="https://blog.golang.org/defer-panic-and-recover">Defer, Panic, and Recover - The Go Blog</a></p>

<p><code>runtime/debug</code> 可以访问调用栈</p>

<h4 id="如何避免过多的-if-err">如何避免过多的 <code>if err</code></h4>

<h2 id="goroutine">goroutine</h2>

<p><code>go</code> 相当于 coroutine 的 <code>launch {}</code></p>

<pre><code>channel ch := make(chan int)
ch &lt;- v    // 将 v 发送至信道 ch。
v := &lt;-ch  // 从 ch 接收值并赋予 v
</code></pre>

<p><code>select</code>  会阻塞到某个分支可以继续执行为止，这时就会执行该分支。当多个分支都准备好时会随机选择一个执行。</p>

<pre><code>select {
case i := &lt;-c:
    // 使用 i
}
</code></pre>

<p>select 控制结构中包含 default 语句，那么这个 select 语句在执行时会遇到以下两种情况：</p>

<ul>
  <li>当存在可以收发的 Channel 时，直接处理该 Channel 对应的 case；</li>
  <li>当不存在可以收发的 Channel 是，执行 default 中的语句；</li>
</ul>

<p>也就变成非阻塞的。</p>

<p>Mutex, goroutine 的锁</p>

<pre><code>// Value 返回给定 key 的计数器的当前值。
func (c *SafeCounter) Value(key string) int {
	c.mux.Lock()
	// Lock 之后同一时刻只有一个 goroutine 能访问 c.v
	defer c.mux.Unlock()
	return c.v[key]
}
</code></pre>

<h2 id="suid-sgid">SUID SGID</h2>

<p>suid 只能用于文件</p>

<p>给目录设置 sgid 可以让其他用户在该目录下创建的文件继承该目录的组权限</p>

<pre><code>sudo chmod g+s /usr/local/bin/htg # 🏠加 sgid bit
</code></pre>

<h2 id="nethttp">net/http</h2>

<p>底层实现在 transport.go</p>

<h2 id="tips">Tips</h2>

<ol>
  <li>bolierplate 算不了什么，可读性才是王道</li>
  <li>如何选择 value or pointer reciever</li>
  <li>go 不支持函数重载，但内置的 <code>make</code> 函数却是重载的</li>
</ol>

<p><a href="https://github.com/golang-standards/project-layout/blob/master/README_zh.md">project-layout/README_zh.md at master · golang-standards/project-layout</a></p>

</article>
<div class="tag-container" >
    
</div>


<div id="disqus_thread"></div>
<script>

 /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
 var jekyll_id = "/notes/Quick/2020/10/note-2020-10-07"
 var disqus_config = function () {
     this.page.title = "2020年10月07日杂记"
     this.page.identifier = "posts"+jekyll_id.substring(jekyll_id.lastIndexOf('/'))+".md"; // required: replace example with your forum shortname
     console.log(this.page.identifier);
     this.page.url = "http://dourok.info/notes/Quick/2020/10/note-2020-10-07/";
    };

 (function() { // DON'T EDIT BELOW THIS LINE
     var d = document, s = d.createElement('script');
     s.src = '//doousblog.disqus.com/embed.js';
     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




<a class="btn-floating btn-large waves-effect waves-light scale-transition fab" id="fab"><i class="material-icons">keyboard_arrow_up</i></a>
</div>
    <div class="col hide-on-small-only m1 xl1 ">
        <a class="btn-floating teal" id='toc-toggle'><i id='toc-toogle-icon' class="material-icons">compare_arrows</i></a>
      </div>
    <div class="col hide-on-small-only m3 xl3 offset-xl1 toc-wrapper">
      <ul class="section table-of-contents">
      </ul>
    </div>
  </button>
</div>
</main>

<footer>
    <div class="container">
        <div class="row">
            <div class="col s12 m5 offset-m1">
                <h5>友情链接</h5>
                <ul class="mdl-mega-footer__link-list">
                    
                    <li><a href="https://magicalboy.com/">MAGICALBOY</a></li>
                    
                    <li><a href="http://www.cnlvzi.com/">驴子博客</a></li>
                    
                </ul>
            </div>
            <div class="col s12 m5">
                <div class="footer-nav">
                    
                    <a href="/">主页</a>
                    
                    <a href="/notes">笔记</a>
                    
                    <a href="/categories#coder-ref">编码</a>
                    
                    <a href="/categories#life-ref">生活</a>
                    
                    <a href="/categories#otaku-ref">兴趣</a>
                    
                    <a href="/tags">标签</a>
                    
                    <a href="/log">日志</a>
                    
                    <a href="/help">帮助</a>
                    
                    <a href="/about">关于</a>
                    
                </div>
        </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            <div class="row">
                <div class="col offset-m1">
                    ©2009-世界末日 | 基於 <a href="https://jekyllrb.com">Jekyll</a> | 主题 <a href="#">Moon</a> | <small class="license">
	                  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="https://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" original="https://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png"></a>
	                  </small>
                </div>
            </div>
        </div>
    </div>
</footer>



        

        

        
    </body>

</html>
