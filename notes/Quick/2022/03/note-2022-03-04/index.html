
<!DOCTYPE html>
<html class="borderbox" >
    
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    2022年03月04日杂记 | DouO's Note</title>
  <meta name="description" content="有時樹會倒下，某片天頃刻明亮
">

  <!-- Favicon -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon" />
  <!-- Windows 8 Tile Icons -->
  <meta name="application-name" content=" Blog">
  <meta name="msapplication-TileColor" content="#5d4d7a">
  <meta name="msapplication-square70x70logo" content="smalltile.png" />
  <meta name="msapplication-square150x150logo" content="mediumtile.png" />
  <meta name="msapplication-wide310x150logo" content="widetile.png" />
  <meta name="msapplication-square310x310logo" content="largetile.png" />
  <!-- Android Lolipop Theme Color -->
  <meta name="theme-color" content="#5d4d7a">
  <script src="/assets/main.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>

    <body>
        <header>
  <nav class="top-nav">
    <div class="container">
      <div class="nav-wrapper">
        <div class="row">
          <div class="col s12 m10 offset-m1">
            <h1 class="header">2022年03月04日杂记</h1>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <div class="container"><a href="#" data-target="nav-mobile" class="top-nav sidenav-trigger full hide-on-large-only"><i class="material-icons">menu</i></a></div>
  <ul id="nav-mobile" class="sidenav sidenav-fixed">
    <li>
      <div class="logo">
        <a id="logo-container" href="/notes" class="brand-logo">
          <object id="front-page-logo" type="image/svg+xml">Your browser does not support SVG</object>
        </a>
        <div class="social">
          
          <a href="/rss.xml" title="订阅">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-feed"></use>
            </svg>
          </a>
          
          <a href="https://github.com/douo" title="Github">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-github"></use>
            </svg>
          </a>
          
          <a href="https://stackoverflow.com/users/851344/douo" title="StackOverflow">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-stack-overflow"></use>
            </svg>
          </a>
          
          <a href="https://plus.google.com/102537448648560113422" title="Google Plus">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-google-plus"></use>
            </svg>
          </a>
          
          <a href="https://instagram.com/douo" title="Instagram">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-instagram"></use>
            </svg>
          </a>
          
        </div>
    </li>
    </div>
    <li class="search">
      <div class="search-wrapper">
        <input id="search" placeholder="Search"><i class="material-icons">search</i>
        <div class="search-results"></div>
      </div>
    </li>
    <li class="no-padding">
      <div id="blog-nav">
        <ul>
          
          <li><a href="/">主页</a></li>
          
          <li><a href="/notes">笔记</a></li>
          
          <li><a href="/categories#coder-ref">编码</a></li>
          
          <li><a href="/categories#life-ref">生活</a></li>
          
          <li><a href="/categories#otaku-ref">兴趣</a></li>
          
          <li><a href="/tags">标签</a></li>
          
          <li><a href="/log">日志</a></li>
          
          <li><a href="/help">帮助</a></li>
          
          <li><a href="/about">关于</a></li>
          
        </ul>
      </div>
      <div id="note-nav"></div>
    </li>
  </ul>
  <div id="nav-tab" class="hide-on-med-and-down">
    <div class="row">
      <ul class="tabs">
        <li class="tab col s6"><a href="#blog-nav">博客</a></li>
        <li class="tab col s6"><a href="#note-nav">笔记</a></li>
      </ul>
    </div>
  </div>
</header>
<!-- Page Layout here -->
<main><div class="container">
  <div class="row">

    <div class="content col s12 m8 offset-m1 xl7 offset-xl1"> <div class="post-meta">
<span class="post-date tooltipped" data-tooltip="最后更新 22-05-30">2022-03-04</span>
    
</div>

<article>
     <p>[2022-03-07 Mon 14:08]</p>
<h1 id="深度学习开发机">深度学习开发机</h1>
<p>Ubuntu 20.04.4 LTS</p>
<h2 id="深度学习开发机--安装">安装</h2>
<p>没什么特殊的</p>
<h2 id="深度学习开发机--一般配置">一般配置</h2>
<h3 id="深度学习开发机--一般配置--sshd">sshd</h3>
<p><code>sudo apt install openssh-server</code></p>
<h3 id="深度学习开发机--一般配置--vnc">vnc</h3>
<p><code>sudo apt install tigervnc-scraping-server</code></p>
<p><a href="~/Writing/_notes/Computer/jetson.md">~/Writing/_notes/Computer/jetson.md</a></p>
<h3 id="深度学习开发机--一般配置--emacs">emacs</h3>
<pre class="src" lang="shell">
sudo add-apt-repository ppa:kelleyk/emacs
sudo apt update
sudo apt install emacs27
</pre>
<h3 id="深度学习开发机--一般配置--zsh">zsh</h3>
<pre class="src" lang="shell">
sudo apt install zsh curl
zsh
sh -c &quot;$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;
omz theme set ys
</pre>
<h3 id="深度学习开发机--一般配置--jtmux">jtmux</h3>
<h3 id="深度学习开发机--一般配置--frpc">frpc</h3>
<p>需要手动安装</p>
<h3 id="深度学习开发机--一般配置--nvidia-driver">nvidia driver</h3>
<ul>
  <li>https://linuxize.com/post/how-to-nvidia-drivers-on-ubuntu-20-04/</li>
  <li>[CUDA Toolkit 11.6 Update 1 Downloads | NVIDIA Developer](https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network)</li>
  <li><code>export PATH=&quot;/usr/local/cuda/bin:$PATH&quot;</code></li>
</ul>
<h2 id="深度学习开发机--开发">开发</h2>
<h3 id="深度学习开发机--开发--pyright">pyright</h3>
<p>conda install pyright</p>
<h3 id="深度学习开发机--开发--jupyter">jupyter</h3>
<pre class="src" lang="shell">
sudo snap install node --classic
pip install jupyterlab
# 显示图片
pip install ipywidgets
jupyter nbextension enable --py widgetsnbextension
jupyter labextension install @jupyter-widgets/jupyterlab-manager
# 支持 pyplot
pip install ipympl
jupyter labextension install @jupyter-widgets/jupyterlab-manager jupyter-matplotlib
# 支持头部折叠
pip install aquirdturtle_collapsible_headings

</pre>
<h3 id="深度学习开发机--开发--conda">conda</h3>
<ul>
  <li>安装到 <code>/opt/miniconda3</code></li>
  <li>[Installing for multiple users — Anaconda documentation](https://docs.anaconda.com/anaconda/install/multi-user/)</li>
  <li>[Installing on Linux — conda 4.11.0.post66+edb5737bd documentation](https://conda.io/projects/conda/en/latest/user-guide/install/linux.html#)</li>
  <li>zsh 插件</li>
</ul>
<pre class="src" lang="shell">
git clone https://github.com/esc/conda-zsh-completion ${ZSH_CUSTOM:=~/.oh-my-zsh/custom}/plugins/conda-zsh-completion
omz plugin enable conda-zsh-completion
</pre>
<h3 id="深度学习开发机--开发--ffmpeg">ffmpeg</h3>
<p>https://trac.ffmpeg.org/wiki/CompilationGuide/Ubuntu
  https://trac.ffmpeg.org/wiki/HWAccelIntro</p>
<pre class="src" lang="shell">
sudo apt-get update -qq &amp;&amp; sudo apt-get -y install \
autoconf \
automake \
build-essential \
cmake \
git-core \
libass-dev \
libfreetype6-dev \
libgnutls28-dev \
libmp3lame-dev \
libsdl2-dev \
libtool \
libva-dev \
libvdpau-dev \
libvorbis-dev \
libxcb1-dev \
libxcb-shm0-dev \
libxcb-xfixes0-dev \
meson \
ninja-build \
pkg-config \
texinfo \
wget \
yasm \
zlib1g-dev \
libunistring-dev \
nasm \
libx264-dev \
libx265-dev \
libnuma-dev \
libvpx-dev \
libfdk-aac-dev \
libopus-dev \
</pre>
<ul>
  <li>编译 opencv 需要 enable-shared https://stackoverflow.com/questions/32785279/ffmpeg-doesnt-compile-with-shared-libraries</li>
  <li>cmake 添加 libaom you need to add: &#8220;-DBUILD_SHARED_LIBS=1&#8221;</li>
  <li>meson &#8211;default-library=shared</li>
</ul>
<p>master 分支</p>
<pre class="src" lang="shell">
PATH=&quot;$HOME/bin:$CUDA_DIR/bin:$PATH&quot; PKG_CONFIG_PATH=&quot;$HOME/ffmpeg_build/lib/pkgconfig&quot; ./configure \
    --prefix=&quot;$HOME/ffmpeg_build&quot; \
    --pkg-config-flags=&quot;--static&quot; \
    --extra-cflags=&quot;-I$HOME/ffmpeg_build/include&quot; \
    --extra-ldflags=&quot;-L$HOME/ffmpeg_build/lib&quot; \
    --extra-libs=&quot;-lpthread -lm&quot; \
    --ld=&quot;g++&quot; \
    --bindir=&quot;$HOME/bin&quot; \
    --enable-shared \
    --disable-static \
    --enable-gpl \
    --enable-gnutls \
    --enable-libaom \
    --enable-libass \
    --enable-libfdk-aac \
    --enable-libfreetype \
    --enable-libmp3lame \
    --enable-libopus \
    --enable-libsvtav1 \
    --enable-libdav1d \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-libx264 \
    --enable-libx265 \
    --enable-nonfree \
    --enable-cuda-sdk \
    --enable-cuvid \
    --enable-nvenc \
    --enable-libnpp \
    --extra-cflags=-I&quot;$CUDA_DIR/include&quot; --extra-ldflags=-L&quot;$CUDA_DIR/lib64&quot; &amp;&amp; \
    PATH=&quot;$HOME/bin:$CUDA_DIR/bin:$PATH&quot; make -j $(nproc) &amp;&amp; \
    make install &amp;&amp; \
    hash -r
</pre>
<p>编译成动态库，需要告诉动态链接去哪里找包</p>
<p>通过环境变量：</p>
<pre class="src" lang="shell">
export LD_LIBRARY_PATH=/home/lc/ffmpeg_build/lib
</pre>
<p>推荐用 <code>ldconfig</code></p>
<p>编辑 sudo vi /etc/ld.so.conf.d/my_ffmpeg_.conf</p>
<pre class="src">
/home/lc/ffmpeg_build/lib
</pre>
<p>再运行</p>
<pre class="src">
sudo ldconfig
</pre>
<p>pkg-config 的作用？ https://www.freedesktop.org/wiki/Software/pkg-config/</p>
<h3 id="深度学习开发机--开发--opencv">opencv</h3>
<p>gui 支持 <code>sudo apt install libgtk2.0-dev libcanberra-gtk-module libcanberra-gtk3-module</code></p>
<p>编译前需要先安装 numpy <code>conda install numpy</code></p>
<p>参考</p>
<ul>
  <li>https://www.cnblogs.com/geoffreyone/p/14765124.html</li>
  <li>https://dev.widemeadows.de/2017/08/23/building-opencv-for-anaconda-python-3/</li>
</ul>
<p>最终能正确生成 cv2 的可用的 cmake
  TODO <code>CMAKE_INSTALL_PREFIX</code> 应该可放到 <code>/usr/local/opencv</code> 方便多个虚拟环境公用</p>
<pre class="src" lang="shell">

cmake \
      -D INCLUDE_DIRS=${OPENCV_INCLUDE_DIR_ANACONDA} $INCLUDE_DIRS \
      -D LIBRARY_DIRS=$OPENCV_LIBRARY_ANACONDA $LIBRARY_DIRS \
      -D CMAKE_BUILD_TYPE=RELEASE \
      -D BUILD_PYTHON_SUPPORT=ON \
      -D BUILD_DOCS=ON \
      -D BUILD_PERF_TESTS=OFF \
      -D BUILD_TESTS=OFF \
      -D CMAKE_INSTALL_PREFIX=$(python3 -c &quot;import sys; print(sys.prefix)&quot;) \
      -D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
      -D BUILD_opencv_python3=ON \
      -D BUILD_opencv_python2=OFF \
      -D INSTALL_PYTHON_EXAMPLES=ON \
      -D PYTHON_EXECUTABLE=&quot;/opt/miniconda3/envs/mmlab/bin/python3&quot; \
      -D PYTHON3_EXECUTABLE=&quot;/opt/miniconda3/envs/mmlab/bin/python3&quot; \
      -D PYTHON_LIBRARY=&quot;/opt/miniconda3/envs/mmlab/lib/libpython3.9.so&quot; \
      -D PYTHON3_LIBRARY=&quot;/opt/miniconda3/envs/mmlab/lib/libpython3.9.so&quot; \
      -D PYTHON3_INCLUDE_DIR=&quot;/opt/miniconda3/envs/mmlab/include/python3.9&quot; \
      -D PYTHON3_INCLUDE_DIR2=&quot;/opt/miniconda3/envs/mmlab/include&quot; \
      -D PYTHON3_NUMPY_INCLUDE_DIRS=$(python3 -c &quot;import numpy; print(numpy.get_include())&quot;) \
      -D PYTHON3_INCLUDE_PATH=&quot;/opt/miniconda3/envs/mmlab/include/python3.9&quot; \
      -D PYTHON3_PACKAGES_PATH=$(python3 -c &quot;from distutils.sysconfig import get_python_lib; print(get_python_lib())&quot;) \
      -D BUILD_EXAMPLES=ON \
      -D WITH_GTK=ON \
      -D WITH_GTK_2_X=ON \
      -D WITH_IPP=ON \
      -D BUILD_TIFF=ON \
      -D BUILD_opencv_cvv=OFF \
      -D INSTALL_CREATE_DISTRIB=ON \
      -D WITH_FFMPEG=ON \
      -D WITH_GSTREAMER=ON \
      -D WITH_V4L=ON \
      -D WITH_LIBV4L=ON \
      -D WITH_TBB=ON \
      -D WITH_QT=ON \
      -D WITH_OPENGL=ON \
      -D WITH_CUDA=ON \
      -D CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda \
      -D CMAKE_LIBRARY_PATH=/usr/local/cuda/lib64/stubs \
      -D CUDA_ARCH_BIN=&quot;7.5&quot; \
      -D CUDA_ARCH_PTX=&quot;&quot; \
      -D WITH_CUBLAS=ON \
      -D WITH_NVCUVID=ON \
      -D ENABLE_FAST_MATH=1 \
      -D CUDA_FAST_MATH=1 \
      -D ENABLE_PRECOMPILED_HEADERS=OFF \
      ..
</pre>
<p>做了这个改动，方便看 ffmpeg 的报错
  https://github.com/opencv/opencv/issues/10217</p>
<p>ffmpeg build shared lib
  https://answers.opencv.org/question/229639/cmake-static-link-ffmpeg-for-build-shared-libraries/
  Opencv build error: relocation R_X86_64_PC32 against symbol `ff_pw_9&#8217; &#8230; recompile with -fPIC</p>
<h3 id="深度学习开发机--开发--mmpose">mmpose</h3>
<ul>
  <li>numpy=1.21.2=py39h20f2e39_0</li>
</ul>
<p><code>conda install pytorch torchvision torchaudio cudatoolkit=11.3 -c pytorch</code></p>
<ul>
  <li>pytorch==1.10.2</li>
  <li>torchvision=0.11.3
    <p><code>pip install openmim</code></p>
    <ul>
      <li>openmim
        <p>mim install mmcv-full   # 会替换了 opencv 版本
          mim install mmdet</p>
      </li>
    </ul>
  </li>
</ul>
<p>mmcls      0.21.0     https://github.com/open-mmlab/mmclassification
  mmcv-full  1.4.6      https://github.com/open-mmlab/mmcv
  mmdet      2.22.0     https://github.com/open-mmlab/mmdetection
  mmpose     0.24.0     https://github.com/open-mmlab/mmpose
  mmtrack    0.11.0     https://github.com/open-mmlab/mmtracking</p>
<p>scikit-learn</p>
 
</article>
<div class="tag-container" >
    
</div>


<div id="disqus_thread"></div>
<script>

 /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
 var jekyll_id = "/notes/Quick/2022/03/note-2022-03-04"
 var disqus_config = function () {
     this.page.title = "2022年03月04日杂记"
     this.page.identifier = "posts"+jekyll_id.substring(jekyll_id.lastIndexOf('/'))+".md"; // required: replace example with your forum shortname
     console.log(this.page.identifier);
     this.page.url = "http://dourok.info/notes/Quick/2022/03/note-2022-03-04/";
    };

 (function() { // DON'T EDIT BELOW THIS LINE
     var d = document, s = d.createElement('script');
     s.src = '//doousblog.disqus.com/embed.js';
     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




<a class="btn-floating btn-large waves-effect waves-light scale-transition fab" id="fab"><i class="material-icons">keyboard_arrow_up</i></a>
</div>
    <div class="col hide-on-small-only m1 xl1 ">
        <a class="btn-floating teal" id='toc-toggle'><i id='toc-toogle-icon' class="material-icons">compare_arrows</i></a>
      </div>
    <div class="col hide-on-small-only m3 xl3 offset-xl1 toc-wrapper">
      <ul class="section table-of-contents">
      </ul>
    </div>
  </button>
</div>
</main>

<footer>
    <div class="container">
        <div class="row">
            <div class="col s12 m5 offset-m1">
                <h5>友情链接</h5>
                <ul class="mdl-mega-footer__link-list">
                    
                    <li><a href="https://magicalboy.com/">MAGICALBOY</a></li>
                    
                    <li><a href="http://www.cnlvzi.com/">驴子博客</a></li>
                    
                </ul>
            </div>
            <div class="col s12 m5">
                <div class="footer-nav">
                    
                    <a href="/">主页</a>
                    
                    <a href="/notes">笔记</a>
                    
                    <a href="/categories#coder-ref">编码</a>
                    
                    <a href="/categories#life-ref">生活</a>
                    
                    <a href="/categories#otaku-ref">兴趣</a>
                    
                    <a href="/tags">标签</a>
                    
                    <a href="/log">日志</a>
                    
                    <a href="/help">帮助</a>
                    
                    <a href="/about">关于</a>
                    
                </div>
        </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            <div class="row">
                <div class="col offset-m1">
                    ©2009-世界末日 | 基於 <a href="https://jekyllrb.com">Jekyll</a> | 主题 <a href="#">Moon</a> | <small class="license">
	                  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="https://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" original="https://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png"></a>
	                  </small>
                </div>
            </div>
        </div>
    </div>
</footer>



        

        

        
    </body>

</html>
